# סיכום פרויקט CRM - QuoteFlow

מסמך זה מספק סיכום מקיף של פרויקט ה-CRM שלך, במטרה להקל עליך את המשך הפיתוח. הניתוח מבוסס על הקוד שסופק מהריפוזיטורי ב-GitHub.

## 1. סקירה כללית

הפרויקט הוא מערכת CRM מורכבת בשם **QuoteFlow**, המיועדת לניהול מלא של הצעות מחיר, לקוחות, ספקים, ומשלוחים. זוהי לא רק מערכת הצעות מחיר פשוטה, אלא פלטפורמת ERP/CRM מלאה המנהלת את כל מחזור החיים של עסקה, החל מבקשת הלקוח ועד למסירת המוצר.

המערכת תומכת בחמישה סוגי משתמשים שונים, כל אחד עם פורטל וסט הרשאות ייעודי:
*   **מנהל (Admin):** גישה מלאה לכל חלקי המערכת, הגדרות, דוחות וניהול משתמשים.
*   **עובד (Employee):** ניהול הצעות מחיר, לקוחות, ספקים ושליחים.
*   **לקוח (Customer):** בקשת הצעות מחיר, צפייה בהיסטוריה ואישור הזמנות.
*   **ספק (Supplier):** קבלת עבודות, עדכון סטטוסים וניהול מחירון.
*   **שליח (Courier):** ניהול איסופים מספקים ומסירות ללקוחות.

## 2. ארכיטקטורה וטכנולוגיות

הפרויקט בנוי בארכיטקטורת Full-Stack מודרנית, המפרידה בין צד הלקוח (Frontend) לצד השרת (Backend).

| קטגוריה | טכנולוגיה | תיאור |
| --- | --- | --- |
| **Frontend** | React, TypeScript, Vite, TailwindCSS | ממשק משתמש ריאקטיבי ומודרני. |
| **Backend** | Node.js, Express, TypeScript, tRPC | שרת API יעיל ובטוח עם Type Safety מלא. |
| **Database** | PostgreSQL, Drizzle ORM | מסד נתונים רלציוני חזק עם ORM מודרני. |
| **UI Components** | Shadcn/UI, Radix UI | ספריית קומפוננטות איכותית ונגישה. |
| **State Management** | React Query (TanStack Query) | ניהול מצב ה-API, קאשינג ועדכונים בזמן אמת. |
| **Authentication** | JWT (JSON Web Tokens) | מנגנון אימות מאובטח מבוסס טוקנים. |
| **Validation** | Zod | ולידציה של קלט בכל שכבות האפליקציה. |

## 3. מבנה הפרויקט

הקוד מאורגן בצורה הגיונית בתיקיות הבאות:

```
CRM/
├── client/         # Frontend (React, Vite)
│   └── src/
│       ├── pages/    # דפי האפליקציה (כ-17 דפים)
│       └── components/ # קומפוננטות UI לשימוש חוזר
├── server/         # Backend (Node.js, tRPC)
│   ├── routers/    # הגיון עסקי ו-API Endpoints (כ-137 נקודות קצה)
│   ├── db/         # פונקציות גישה למסד הנתונים (כ-136 פונקציות)
│   └── _core/      # קבצי ליבה של השרת (TRPC, אימות, וכו')
├── drizzle/        # הגדרות מסד הנתונים
│   └── schema.ts   # סכמת כל הטבלאות (21 טבלאות)
└── shared/         # קוד המשותף בין השרת והלקוח
```

## 4. מורכבויות עסקיות מרכזיות

הקוד מטפל במספר לוגיקות עסקיות מורכבות:

1.  **מערכת תמחור (5 רמות):** מאפשרת גמישות גבוהה בתמחור ללקוחות שונים, עם אפשרות לדריסה ידנית.
2.  **Workflow הצעות מחיר:** ניהול סטטוסים מורכב (מעל 10 סטטוסים) עם מעברים מוגדרים ולוגיקה עסקית לכל שלב.
3.  **מערכת המלצות ספקים:** אלגוריתם אוטומטי המדרג וממליץ על ספקים על בסיס 5 פרמטרים (מחיר, זמן אספקה, דירוג, אמינות, ניסיון).
4.  **וולידציית קבצים (Pre-press):** מערכת לבדיקת קבצי הדפסה לפי פרופילים מוגדרים (DPI, CMYK, Bleed, וכו').
5.  **פורטלים ייעודיים:** ממשקים נפרדים ומותאמים לכל אחד מחמשת סוגי המשתמשים.

## 5. מסד נתונים (Database)

סכמת מסד הנתונים כוללת **21 טבלאות** המנהלות את כל היבטי המערכת. הטבלאות המרכזיות הן:

*   `users`: כל המשתמשים והתפקידים.
*   `base_products`, `product_sizes`, `size_quantities`: קטלוג המוצרים והמחירים.
*   `pricelists`, `pricelist_items`: מערכת המחירונים.
*   `quotes`, `quote_items`: הצעות המחיר והפריטים שבהן.
*   `supplier_jobs`, `supplier_prices`: ניהול עבודות ומחירי ספקים.
*   `activity_log`: מעקב אחר כל הפעולות במערכת.

חיבור למסד הנתונים שסיפקת הוגדר בקובץ `.env`.

## 6. משימות פתוחות (TODO)

על פי קובץ `todo.md`, רוב המשימות המרכזיות הושלמו. המשימה היחידה שנותרה פתוחה היא:

*   **[ ] File upload component with drag & drop:** השלמת רכיב העלאת קבצים עם תמיכה בגרירה ושחרור.
*   **[ ] File validation feedback UI with warnings:** הצגת משוב ויזואלי למשתמש על תוצאות ולידציית הקבצים.

## 7. באגים ובעיות ידועות

ניתוח הקוד העלה **12 באגים ובעיות**, מתוכם **4 קריטיים**. הנה סיכום הבעיות החשובות ביותר הדורשות טיפול מיידי:

| רמת חומרה | תיאור הבעיה | קובץ | המלצה |
| --- | --- | --- | --- |
| **קריטי** | **חוסר בדיקת הרשאות** ביצירת הצעת מחיר. | `server/routers.ts` | הוספת בדיקה שרק לקוח/עובד/מנהל יכול ליצור הצעה. |
| **קריטי** | **Race Condition** ביצירת מספר הצעת מחיר. | `server/db.ts` | שימוש ב-Transaction כדי להבטיח מספרים ייחודיים. |
| **קריטי** | **פוטנציאל ל-SQL Injection** בעדכון עבודת ספק. | `server/db.ts` | שימוש בפונקציות ה-ORM של Drizzle במקום SQL גולמי. |
| **קריטי** | **חוסר בדיקת בעלות** במחיקת הערות פנימיות. | `server/db.ts` | הוספת בדיקה שהמשתמש הוא בעל ההערה או מנהל. |
| בינוני | חוסר ולידציה של אימייל ייחודי ביצירת לקוח. | `server/createCustomerWithQuote.ts` | בדיקה שהאימייל לא קיים במערכת לפני יצירת משתמש חדש. |
| בינוני | לולאה אינסופית פוטנציאלית בהיסטוריית הצעות מחיר. | `server/db.ts` | הוספת מעקב אחר מזהים שנבדקו כדי למנוע לולאות. |

## 8. המלצות להמשך

1.  **טיפול בבאגים הקריטיים:** זהו הצעד הראשון והחשוב ביותר. יש לתקן את בעיות האבטחה ועקביות הנתונים לפני כל פיתוח נוסף.
2.  **השלמת משימות ה-TODO:** השלמת רכיב העלאת הקבצים והצגת המשוב למשתמש תסיים את התכנון המקורי של המערכת.
3.  **Refactoring ושיפור הקוד:**
    *   **הגדרת `relations.ts`:** הגדרת הקשרים בין טבלאות ב-Drizzle תשפר את ביצועי השאילתות ותפשט אותן.
    *   **הימנעות מ-`any`:** המרת טיפוסי `any` לטיפוסים ספציפיים תשפר את יציבות הקוד.
    *   **הוספת Transactions:** שימוש נרחב יותר בטרנזקציות בפעולות DB מורכבות.
4.  **התקנת תלויות והרצת הפרויקט:**
    *   הרץ `pnpm install` כדי להתקין את כל התלויות.
    *   הרץ `pnpm run dev` כדי להפעיל את סביבת הפיתוח המקומית.

אני מקווה שסיכום זה יעזור לך לחזור לפרויקט ולהמשיך את העבודה הנהדרת שכבר נעשתה.
